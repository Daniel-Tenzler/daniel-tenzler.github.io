---
import type { CollectionEntry } from 'astro:content';
import BaseHead from 'src/components/astro/BaseHead.astro';
import BlogPost from 'src/components/jsx/blog/BlogPost/BlogPost';
import TableOfContents from 'src/components/jsx/blog/TableOfContents/TableOfContents';
import Breadcrumb from 'src/components/jsx/ui/Breadcrumb/Breadcrumb';
import Footer from 'src/components/jsx/footer/Footer/Footer';
import Header from 'src/components/jsx/header/Header/Header';
import { COLORS } from 'src/consts/Colors';
import '../styles/layouts-shared.css';

type Props = {
	title: string;
	description: string;
	pubDate: Date;
	updatedDate?: Date;
	heroImage?: string;
	coverImage?: string;
	readTime?: string;
	tags?: string[];
	author?: string;
	headings?: { depth: number; slug: string; text: string }[];
};

const {
	title,
	description,
	pubDate,
	updatedDate,
	heroImage,
	coverImage,
	readTime,
	tags,
	author,
	headings,
} = Astro.props;
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead
			title={title}
			description={description}
			image={coverImage || heroImage || '/blog-placeholder-2.jpg'}
			structuredData={{
				'@context': 'https://schema.org',
				'@type': 'BlogPosting',
				headline: title,
				description: description,
				image: coverImage || heroImage || '/blog-placeholder-2.jpg',
				author: {
					'@type': 'Person',
					name: author || 'Daniel Tenzler',
				},
				publisher: {
					'@type': 'Organization',
					name: 'Daniel Tenzler',
					logo: {
						'@type': 'ImageObject',
						url: '/favicon.svg',
					},
				},
				datePublished: pubDate.toISOString(),
				dateModified:
					updatedDate?.toISOString() || pubDate.toISOString(),
				mainEntityOfPage: {
					'@type': 'WebPage',
					'@id': Astro.url.href,
				},
				wordCount: readTime
					? parseInt(readTime.replace(/\D/g, ''))
					: undefined,
				keywords: tags?.join(', '),
				articleSection: tags?.[0] || 'Blog',
			}}
		/>

		<!-- Inline script for no-flash dark mode -->
		<script is:inline>
			(function() {
				const stored = localStorage.getItem('theme');
				if (stored) {
					document.documentElement.setAttribute('data-theme', stored);
				} else {
					const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
					document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
				}
			})();
		</script>
	</head>
	<body>
		<a href="#main-content" class="skip-link">Skip to main content</a>
		<div class="min-h-screen flex flex-col">
			<Header id="navigation" client:visible />
			<main id="main-content" class="flex-grow blog-layout">
				<div class="blog-layout-wrapper">
					<div class="blog-content">
						<Breadcrumb
							client:idle
							items={[
								{ label: 'Home', href: '/' },
								{ label: 'Blog', href: '/blog' },
								{ label: title },
							]}
						/>
						<BlogPost
							client:visible
							title={title}
							pubDate={pubDate}
							updatedDate={updatedDate}
							heroImage={heroImage}
							readTime={readTime}
							tags={tags}
							author={author}
						>
							<div class="prose">
								<slot />
							</div>
						</BlogPost>
					</div>
					<aside class="toc-sidebar">
						<TableOfContents client:idle headings={headings} />
					</aside>
				</div>
			</main>
			<Footer client:idle />
		</div>
	</body>
</html>

<style is:global>
	/* Blog post-specific layout overrides */
	body {
		line-height: 1.7;
		background-size: 100% 100%;
	}

	main.blog-layout {
		width: 920px;
		max-width: calc(100% - 2em);
		margin: auto;
		padding: 2em 1em;
		min-height: calc(100vh - (201px + 4rem));
	}

	.toc-sidebar {
		position: fixed;
		display: block;
		right: 100px;
		top: 100px;
	}

	@media (max-width: 720px) {
		main.blog-layout {
			padding: 1em;
		}
		.toc-sidebar {
			position: relative;
			right: auto;
			top: auto;
			margin-bottom: 2rem;
		}
	}
</style>

<style>
	.prose {
		max-width: 85ch;
		color: var(--gray-e5e9f0);
	}

	.prose :global(h1) {
		color: var(--gray-e5e9f0);
		font-weight: 800;
		font-size: 2em;
		margin-top: 0;
	}

	.prose :global(h2) {
		color: var(--gray-e5e9f0);
		font-weight: 700;
		font-size: 1.5em;
		margin-top: 2em;
		margin-bottom: 1em;
		line-height: 1.3;
	}

	.prose :global(h3) {
		color: var(--gray-e5e9f0);
		font-weight: 600;
		font-size: 1.25em;
		margin-top: 1.6em;
		margin-bottom: 0.6em;
		line-height: 1.6;
	}

	.prose :global(p) {
		font-size: 20px;
		margin-top: 1.25em;
		margin-bottom: 1.25em;
	}

	.prose :global(a) {
		color: var(--accent);
		text-decoration: underline;
		font-weight: 500;
	}

	.prose :global(strong) {
		color: var(--gray-e5e9f0);
		font-weight: 600;
	}

	.prose :global(code) {
		color: var(--gray-e5e9f0);
		font-weight: 600;
		font-size: 0.875em;
	}

	.prose :global(pre) {
		color: var(--gray-e5e9f0);
		background-color: var(--gray-e5e9f0);
		overflow-x: auto;
		font-size: 0.875em;
		line-height: 1.7142857;
		margin-top: 1.7142857em;
		margin-bottom: 1.7142857em;
		border-radius: 0.375rem;
		padding: 0.8571429em 1.1428571em;
	}

	.prose :global(blockquote) {
		font-weight: 500;
		font-style: italic;
		color: var(--gray-e5e9f0);
		border-left-width: 0.25rem;
		border-left-color: var(--gray-e5e9f0);
		quotes: '\201C' '\201D' '\2018' '\2019';
		margin-top: 1.6em;
		margin-bottom: 1.6em;
		padding-left: 1em;
	}

	.prose :global(ul) {
		margin-top: 1.25em;
		margin-bottom: 1.25em;
		list-style-type: disc;
		padding-left: 1.625em;
	}

	.prose :global(ol) {
		margin-top: 1.25em;
		margin-bottom: 1.25em;
		list-style-type: decimal;
		padding-left: 1.625em;
	}

	.prose :global(li) {
		margin-top: 0.5em;
		margin-bottom: 0.5em;
	}

	.prose :global(img) {
		margin-top: 2em;
		margin-bottom: 2em;
		border-radius: 0.375rem;
		display: block;
		margin-left: 50%;
		transform: translateX(-50%);
		width: 100vw;
		max-width: 70vw;
		position: relative;
		left: 50%;
		right: 50%;
		margin: 0 auto;
	}

	.prose :global(hr) {
		margin-top: 3em;
		margin-bottom: 3em;
		border-color: var(--gray-e5e9f0);
	}

	.blog-layout-wrapper {
		width: 920px;
		max-width: calc(100% - 2em);
		margin: auto;
		padding: 2em 1em;
		display: flex;
		gap: 2rem;
	}

	@media (max-width: 720px) {
		.blog-layout-wrapper {
			width: 100%;
			padding: 1em;
			flex-direction: column;
		}
	}
</style>
