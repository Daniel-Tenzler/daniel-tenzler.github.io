---
import { SITE_TITLE, SITE_DESCRIPTION } from 'src/consts/SiteData';
import MainLayout from 'src/layouts/MainLayout.astro';
import GridBackground from 'src/components/jsx/gridBackground/GridBackground/GridBackground';
import HeroSection from 'src/components/jsx/home/HeroSection/HeroSection';
import LatestPostsSection from 'src/components/jsx/home/LatestPostsSection/LatestPostsSection';
import AboutSection from 'src/components/jsx/home/AboutSection/AboutSection';
import JourneySection from 'src/components/jsx/home/JourneySection/JourneySection';
import SkillsSection from 'src/components/jsx/home/SkillsSection/SkillsSection';
import GitHubStats from 'src/components/jsx/home/GitHubStats/GitHubStats';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import type { BlogPostFrontmatter } from 'src/types/astro.types';
import portfolioData from 'src/data/portfolio/portfolio.json';
import PortfolioPreview from 'src/components/jsx/home/PortfolioPreview/PortfolioPreview';
import {
	prepareResponsiveImageData,
	PORTFOLIO_IMAGE_WIDTHS,
	PORTFOLIO_IMAGE_SIZES,
} from 'src/infrastructure/imageUtils';
import {
	getRepoMetadata,
	getCommitCount,
	fetchRepositories,
	getLanguageStats,
} from 'src/lib/github';
import ContentContainer from 'src/components/jsx/blog/ContentContainer/ContentContainer';
import { journeyData } from 'src/data/journey/journey';
import { skillsData, skillCategories } from 'src/data/skills/skills';
import { generatePersonSchema } from 'src/infrastructure/structuredData';
import { SITE_URL } from 'src/consts/SiteData';

const latestPosts = (await getCollection('blog'))
	.sort(
		(a: CollectionEntry<BlogPostFrontmatter>, b: CollectionEntry<BlogPostFrontmatter>) =>
			b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
	)
	.slice(0, 2)
	.map((post: CollectionEntry<BlogPostFrontmatter>) => ({
		title: post.data.title,
		description: post.data.description,
		pubDate: new Date(post.data.pubDate),
		heroImage: post.data.heroImage,
		slug: post.id,
		readTime: post.data.readTime,
		tags: post.data.tags,
	}));

const aboutParagraphs = [
	"I'm a full-stack web developer focused on building fast, accessible, and user-friendly apps. This site is where I test out new web technologies when I have the time.",
];

const featuredProjects = portfolioData.projects
	.filter((project) => project.featured)
	.map((project) => ({
		...project,
		responsiveImage: prepareResponsiveImageData(
			project.image,
			PORTFOLIO_IMAGE_WIDTHS,
			PORTFOLIO_IMAGE_SIZES
		),
	}));

// GitHub data fetching
const startTime = Date.now();

let metadata = null;
let commitCount = null;
let languageStats = null;

try {
	const [apiMetadata, apiCommitCount, repos] = await Promise.all([
		getRepoMetadata().catch((err) => {
			console.warn('Repo metadata failed, using null:', err.message);
			return null;
		}),
		getCommitCount().catch((err) => {
			console.warn('Commit count failed, using null:', err.message);
			return null;
		}),
		fetchRepositories('daniel-tenzler').catch((err) => {
			console.warn('Repository fetch failed, using null:', err.message);
			return null;
		}),
	]);

	metadata = apiMetadata;
	commitCount = apiCommitCount;
	languageStats = repos ? getLanguageStats(repos) : null;

	const endTime = Date.now();
	console.log(
		`Parallel GitHub API calls completed in ${endTime - startTime}ms`
	);
} catch (error) {
	console.error('Unexpected error in GitHub API calls:', error);
}

// Generate Person schema for the homepage
const personSchema = generatePersonSchema(SITE_URL, {
	jobTitle: 'Full-Stack Web Developer',
	description: SITE_DESCRIPTION,
	sameAs: ['https://github.com/daniel-tenzler'],
});
---

<MainLayout
	title={SITE_TITLE}
	description={SITE_DESCRIPTION}
	structuredData={personSchema}
>
	<GridBackground client:visible />

	<ContentContainer>
		<HeroSection client:visible />

		<PortfolioPreview client:visible projects={featuredProjects} />

		<LatestPostsSection posts={latestPosts} />

		<AboutSection paragraphs={aboutParagraphs} />

		<JourneySection client:idle data={journeyData} />

		<SkillsSection skills={skillsData} categories={skillCategories} />

		{
			metadata && commitCount !== null && languageStats && (
				<GitHubStats
					metadata={metadata}
					commitCount={commitCount}
					languageStats={languageStats}
				/>
			)
		}
	</ContentContainer>
</MainLayout>

<style>
	:global(.bg-accent) {
		background-color: var(--accent);
	}
	:global(.bg-accent-dark) {
		background-color: var(--accent-dark);
	}
	:global(.text-accent) {
		color: var(--accent);
	}
	:global(.hover\:text-accent:hover) {
		color: var(--accent);
	}
	:global(.hover\:bg-accent-dark:hover) {
		background-color: var(--accent-dark);
	}
	:global(.focus\:ring-accent:focus) {
		--tw-ring-color: var(--accent);
	}
</style>
