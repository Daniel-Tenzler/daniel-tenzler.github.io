---
import { SITE_TITLE, SITE_DESCRIPTION, SITE_URL } from 'src/consts/SiteData';
import MainLayout from 'src/layouts/MainLayout.astro';
import { getCollection } from 'astro:content';
import BlogContainer from 'src/components/jsx/blog/BlogContainer/BlogContainer';
import GridBackground from 'src/components/jsx/gridBackground/GridBackground/GridBackground';
import ContentContainer from 'src/components/jsx/blog/ContentContainer/ContentContainer';
import { generateBlogIndexSchema } from 'src/utils/structuredData';

const posts = (await getCollection('blog'))
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.map((post) => ({
		...post,
		data: {
			...post.data,
			pubDate: new Date(post.data.pubDate),
		},
	}));

// Get all unique tags from posts
const allTags = [
	...new Set(posts.flatMap((post) => post.data.tags || [])),
].sort();

const structuredData = generateBlogIndexSchema(posts, SITE_URL);
---

<MainLayout title={`${SITE_TITLE}`} description={SITE_DESCRIPTION} structuredData={structuredData}>
	<GridBackground client:visible />
	<ContentContainer client:load>
		<BlogContainer client:load posts={posts} allTags={allTags} />
	</ContentContainer>
</MainLayout>
